CHANGE LOG FOR UNIFIED 3DVAR CODE
---------------------------------
Author(s)   :  Lidia Cucurull, John Derber, Wei Gu, Jing Guo, Masahiro 
               Kazumori, Daryl Kleist, Xu Li, Jacques Middlecoff, Dave 
               Parrish, Manuel Pondeca, Jim Purser, Xiujuan Su, Meta 
               Sienkiewicz, Ricardo Todling, Russ Treadon, Wan-Shu Wu
Reviewer(s) :  Ricardo Todling, Russ Treadon
Date        :  28 December 2005
GMAO CVS tag:  
NCEP CVS tag:  ncep-gsi-2005_12



REASON FOR CHANGES
------------------
Changes are made to the gsi code for the following reasons:
(listing  below not given in any particular order)

 a) Initial thinning of satellite data requires land-sea-ice mask
    sst, snow depth and ice fields.  These are not currently available
    in regional mode until after reading the guess.  This has been corrected.

 b) Jim Purser has made a small correction to the blended triad routine used
    in the anisotropic recursive filter.

 c) Correct error in read of roughness length field.  Forgot to convert from
    input staggered grid to analysis grid.

 d) Change raflib.F90 to raflib.f90

 e) Add option to use boundary layer model for assimilation of surface 
    temperature observations

 f) Decouple time tendency routines/arrays from Jc term

 g) Modifications for qoption 2

 h) Remove interfaces for int and stp routines

 i) Unify handling for qoption =1, qoption=2

 j) Slight improvement in thinning and qc for satellite data

 k) Inclusion of mean bias in thinning routines where appropriate

 l) Fix bugs in restart (now works) and setupq

 m) Modify restart to create search direction rather than direct update

 n) Move read guess and background error calculation outside external 
    iteration loop

 o) Make calculation of stepsize, gradient and penalty reproducible

 p) Introduce the ability to assimilate gps bending angle observations

 q) Add ability to read/process real AMSR-E data.  Related to this
    divide AMSR-E data into three types:  amsre_low, amsre_mid, amsre_hig

 r) Modify variational qc parts for conventional observation data 
    type: temperature, surface pressure, wind and humidity

 s) Modify conventional diagnostic output items (added ratio 
    original error/inflated error)

 t) Temperature problems in the Arctic islands in Northern Canada, 
    temporarily turn off AMSU-A channels 1-5 and 15 of NOAA 15 16 18 and
    AQUA EOS

 u) Bug fix of qoption=2 in hybrid regional mode. Set to zero the 
    sensitivity to pressure in levels with constant pressure.

 v) Stratospheric clouds observed with qoption=2; turn off temperature 
    sensitivity above 150 mb in regional mode.

 w) For computational efficiency, skip calculation if factqmax and 
    factqmin both are zero in limq routines.

 x) Add option to perturb conventional observations.

 y) Add ability to read/process AVHRR GAC 1b data

 z) Rename tangent linear routine and variable names to be consistent with
    gsi coding convention



SPECIAL NOTES
-------------
The following points should be noted with regards to the above
code changes.  The lettering below corresponds to the
"REASON FOR CHANGES" for lettering above:

 e) There appears to be a bug in the boundary layer code.  When this
    option is turned on, results not correct.  Still searching for bug

 g) Results will change due to adjustments for qoption 2

 l) Bug fix in setupq improves qc

 a,j,k) A few more radiance observations will get through qc

 l,m) Restart result will work and change slightly

 o) Reproducible results in the iteration (sums outside iteration may not 
    reproducible)

 p) To assimilate gps refractivity, specify "gps_ref" as the data 
    type (dtype) in namelist OBS_INPUT.  Use "gps_bnd" to process
    gps bending angle observations.  GPS local refractivity and bending 
    angle are in the same NCEP bufr file.

 r) Variational qc is turned ON in the rungsi_global.sh script.  This
    is done for regression testing.  Variational qc remains under
    investivation.  Users who want to run the gsi without variational
    qc may do so by simply removing "niter_no_qc(1)=60,niter_no_qc(2)=0"
    from namelist SETUP.

 s) The conventional diagnostic files contain an extra entry - the
    ratio of the original observation error to the possibly inflated
    value.  Code which process conventional diagnostic files will
    need to be modified accordingly if using conventional diagnost files
    generated from this gsi version.

 x) Namelist variables perturb_conv and pfact in SETUP control optional
    perturbation of conventional observations



EXPECTED DIFFERENCES
--------------------
The following differences are expected when comparing GSI output from
this release from that from previous releases.  The lettering below
corresponds to the "REASON FOR CHANGES" for lettering above:

 a,j,k) Differences due to different initial selection of satellite
    data in the intelligent thinning.

 b) Differences of around 1 percent when using anisotropic filter,
    but only for background error applied to surface pressure,
    because Jim's change only applies to 2 dimensional fields.

 e) Different results when boundary layer model is turned on

 g,u,v) Modification to qoption=2 alter results



FILES REMOVED
-------------
 ajmpcp.f90                - renamed as pcp_k.f90
 calctends_adj.f90         - renamed as calctends_ad.f90
 calctends_tlm.f90         - renamed as calctends_tl.f90
 pcpinfo.F90               - replaced by pcpinfo.f90
 raflib.F90                - replaced by raflib.f90
 read_gps_ref.f90          - replaced by read_gps.f90
 t_init_var.f90            - renamed as init_var_tl.f90
 t_jfunc.f90               - renamed as jfunc_tl.f90
 t_obsmod.f90              - renamed as obsmod_tl.f90



FILES ADDED
-----------
 calctends_ad.f90          - add tracer tendencies, use new module and guess
                             arrays
 calctends_tl.f90          - add tracer tendencies, use new module and guess
                             arrays
 compute_derived.f90       - contains external iteration dependent calculations
                             on grid
 genstats_gps.f90          - accumulate statistics and apply superobs factor 
                             for gps refractivity or bending angle observations
 init_var_tl.f90           - rename of routine t_init_var.f90
 intbend.f90               - adjoint operator for gps bending angle obs
 jfunc_tl.f90              - rename of routine t_jfunc.f90
 lagmod.f90                - file containing code used for lagrange 
                             interpolation
 obsmod_tl.f90             - rename of routine t_obsmod.f90
 pcp_k.f90                 - rename of routine ajmpcp.f90; rename adjoint 
                             variables to be consistent with gsi standard -> 
                             suffix adjoint variables "_ad"
 pcpinfo.f90               - remove IBM extension to random number generator -
                             this allows removal of machine specific ifdef's
 q_diag.f90                - calculate statistics (count/RMS) for negative q
                             and supersaturated grid points
 raflib.f90                - replace gettri4 with new routine provided by 
                             Jim Purser; return code from F90 to f90 by 
                             changing "use mpi" to "use mpimod" and 
                             commenting out ibm specific cpu time calls;
                             rename ad_raf4 as rad4_ad to be consistent with 
                             gsi adjoint naming convention
 read_avhrr.f90            - read AVHRR GAC 1b data
 read_gps.f90              - replace routine read_gps_ref.f90; add ability to
                             process gps bending angle obs; add preliminary qc;
                             add errors for bending angle
 read_modsbufr.f90         - read marine data (just SST for now)
 retrieval_amsre.f90       - compute various quantities from AMSR-E brightness
                             temperature data.  computed quantities used in qc
 setupbend.f90             - forward model and qc for gps bending angle obs
 sfc_model.f90             - routine containing boundary layer routines
 stpbend.f90               - step size routine for gps bending angle obs
 tendsmod.f90              - countains arrays/subroutines for time tendencies 
                             of increment



FILES MODIFIED
-------------- 
  anberror.f90             - remove anset_ozone_var (included in anprewgt_reg)
  anbkerror_reg.f90        - change raf4_ad call to be consistent with change 
                             in routine name
  anprewgt_reg.f90         - remove unused arrays from jfunc module use 
                             statement; unify ozone variance calculations
  balmod.f90               - make handling of qoption=1 similar to that for 
                             qoption=2
  berror.f90               - native grid implementation, merged w/
                             ncep-gsi_2005_10; remove set_ozone_var (included 
                             in prewgt_reg and prewgt)
  calctends.f90            - add tracer tendencies, use new module and guess 
                             arrays
  deter_subdomain.f90      - cosmetic change to format statement
  dprodx.F90               - make gradient and beta calculation reproducible 
                             (to within roundoff)
  fpvsx_ad.f90             - rename adjoint variables to be consistent with
                             gsi standard -> suffix adjoint variables "_ad"
  genqsat.f90              - add dmax array to decouple moisture from temp and
                             pressure for questionable qsat (i.e., low 
                             pressures)
  get_derivatives.f90      - removed redundant lines; include routine to get 
                             derivatives of surface terrain height
  getprs.f90               - replace _tlm and _adj suffixes on getprs routines
                             with _tl and _ad, the gsi coding convention
  glbsoi.f90               - delayed destroy of sfc fields after main loop; 
                             merged w/ ncep-gsi_2005_10; use tendency module;
                             add calls to get moisture diagnostics; move read
                             guess and background error routines out of
                             external iteration loop
  gscond_ad.f90            - rename adjoint variables to be consistent with
                             gsi standard -> suffix adjoint variables "_ad"
  gsimain.F90              - add new logical variable "sfcmodel" to namelist
                             SETUP; add tendsflag to SETUP; use new tendency 
                             module; if wrf-mass or 2dvar ensure constraint is 
                             off; add logical and factor to perturb 
                             conventional data
  gsisub.f90               - moved call to gengrid_vars to ncep initialization 
                             part; merged w/ ncep-gsi_2005_10
  guess_grids.f90          - add guess time tendency arrays; add ozmz (from 
                             obsmod); remove psfcg
  intall.f90               - modify call to intt for boundary layer model; 
                             separate tendencies from Jc term; all call to 
                             calctends adjoint; remove interfaces and clean 
                             up code; add call to intbend for gps bending 
                             angle data; rename tlm routine and variables to
                             be consistent with gsi coding convention
  intdw.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intjc.f90                - remove call to calctends_adj
  intlimq.f90              - remove interfaces; return if factqmin=factqmax=0;
                             rename tlm routine and variables to be consistent 
                             with gsi coding convention
  intoz.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intpcp.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intps.f90                - remove interfaces; modify gradient operator for
                             variational qc; rename tlm routine and variables
                             to be consistent with gsi coding convention
  intpw.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intq.f90                 - remove interfaces; modify gradient operator for
                             variational qc; rename tlm routine and variables
                             to be consistent with gsi coding convention
  intrad.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intref.f90               - remove interfaces; correct bugs; clean up code;
                             rename tlm routine and variables to be consistent 
                             with gsi coding convention
  intrp3oz.f90             - remove unused variable
  intrw.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intspd.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intsrw.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intsst.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  intt.f90                 - include boundary layer model option; remove 
                             interfaces; modify gradient operator for 
                             variational qc; rename tlm routine and variables
                             to be consistent with gsi coding convention
  intw.f90                 - remove interfaces; modify gradient operator for
                             variational qc; rename tlm routine and variables
                             to be consistent with gsi coding convention
  jcmod.f90                - tendency arrays moved to tendsmod
  jfunc.f90                - expand pointers to include tracer tendencies; 
                             remove unused arrays from jfunc module; fix
                             bug in restart
  m_fvAnaGrid.F90          - native grid implementation
  m_gsiCheck.F90           - native grid implementation
  m_gsiGuess.F90           - native grid implementation
  nlmsas_ad.f90            - rename adjoint variables to be consistent with
                             gsi standard -> suffix adjoint variables "_ad"
  normal_rh_to_q.f90       - use 3d pressure increment for coupling to q
                             (don't assume sigma); make handling of qoption=1
                             similar to that for qoption=2
  obs_para.f90             - replace "ref" variables with "gps" counterparts
  obsmod.f90               - add "sfcmodel", "use_sfc_model_t" and "tlm_sfc" 
                             variables; add variables, flag and function 
                             for perturbing obs
  omegas_ad.f90            - rename adjoint variables to be consistent with
                             gsi standard -> suffix adjoint variables "_ad"
  pcgsoi.f90               - remove interface calls to stpcalc and intall
  prewgt.f90               - native grid implementation; merged w/ 
                             ncep-gsi_2005_10; unify ozone variance 
                             calculations
  prewgt_reg.f90           - unify ozone variance calculations
  qcmod.f90                - replace "ref" variables with "gps" counterparts
  qcssmi.f90               - removed redundant lines; add amsre qc
  radinfo.f90              - fix bug in format used to read SST dependent AVHRR
                             bias correction
  read_airs.f90            - add getsfc routines for all regional options, 
                             remove previous patch that set everything over 
                             water for regional mode; include mean bias
  read_amsre.f90           - same getsfc change as read_airs.f90; modify
                             to read real amsre data; add zensun subroutine
                             to calculate sun zenith and sun azimuth angle;
                             add surface determination code for low frequency 
                             channel
  read_avhrr_navy.f90      - same getsfc change as read_airs.f90; clean up
                             code; use operational bufr table for Navy AVHRR
                             radiance data
  read_bufrtovs.f90        - same getsfc change as read_airs.f90; include
                             mean bias and change thinning
  read_goesimg.f90         - same getsfc change as read_airs.f90
  read_goesndr.f90         - same getsfc change as read_airs.f90; include
                             mean bias
  read_guess.f90           - change to calls to genqsat and calctends; make
                             handling of qoption=1 similar to that for
                             qoption=2; remove external iteration dependent;
                             add ozmz calculation
  read_ieeetovs.f90        - same getsfc change as read_airs.f90
  read_l2bufr_mod.f90      - merged w/ ncep-gsi_2005_10
  read_lidar.f90           - add routine tag to convinfo printout
  read_obs.f90             - divide amsre obstype int three 'obstype' - 
                             amsre_low,amsre_mid,amsre_hig; add option to
                             read  AVHRR GAC 1b data; read sst data from 
                             marine bufr file
  read_ozone.F90           - add routine tag to convinfo printout 
  read_pcp.f90             - same getsfc change as read_airs.f90
  read_prepbufr.f90        - add routine tag to convinfo printout;
                             fix potential overflow problem when using error
                             table; fix bug in deallocation of array dpres
  read_radar.f90           - add routine tag to convinfo printout
  read_ssmi.f90            - same getsfc change as read_airs.f90
  read_ssmis.f90           - same getsfc change as read_airs.f90
  read_superwinds.f90      - add routine tag to convinfo printout; place 
                             upper/lower bound on longitude
  read_wrf_mass_guess.F90  - add input of roughness length field for netcdf 
                             format to correspond with what is already in 
                             binary format routine; change to call to genqsat;
                             make handling of qoption=1 similar to that for 
                             qoption=2; remove external iteration dependent 
                             calculations
  read_wrf_nmm_guess.F90   - change to calls to genqsat and calctends;
                             make handling of qoption=1 similar to that for 
                             qoption=2; remove external iteration dependent 
                             calculations
  retrieval_mi.f90         - bug fix: move tb22v test to avoid negative log 
                             evaluation; removed obstype amsre
  satthin.F90              - add new routines getsfc_nmm_binary, 
                             getsfc_nmm_netcdf, getsfc_mass_binary, 
                             getsfc_mass_netcdf
  setupdw.f90              - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps
  setupjc.f90              - use arrays from guess_grids for guess tendencies;
                             optimize
  setupoz.f90              - clean up code (reformatting)
  setuppcp.f90             - remove call to deter_sfc_reg (earlier patch for 
                             regional mode); rename adjoint variables to be 
                             consistent with gsi standard -> suffix adjoint 
                             variables "_ad"
  setupps.f90              - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps; modify 
                             statistics and gross check by variational qc; 
                             add ratio(original error/inflated error) to 
                             diagnostic output; modify the weight output in 
                             diagnostic output; add option to perturb 
                             conventional obs
  setuppw.f90              - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps
  setupq.f90               - bug fix: lat/lon arrays were inverted to diag 
                             file; change in call to genqsat and fix bug; 
                             remove psfcg by using ges_lnps; modify 
                             statistics and gross check by variational qc; 
                             add ratio(original error/inflated error) to 
                             diagnostic output; modify the weight output 
                             in diagnostic output; add option to perturb 
                             conventional obs
  setuprad.f90             - remove call to deter_sfc_reg (earlier patch for 
                             regional mode); change in qc for amsua 1-3 and 
                             15; modify code related to processing of amsre 
                             data; modify processing of avhrr_navy; add code 
                             to process avhrr data
  setupref.f90             - remove psfcg by using ges_lnps; correct bugs; 
                             clean up code
  setuprhsall.f90          - remove ozmz calculation (to read_guess); add 
                             logic to call setup for either gps refractivity 
                             or bending angle; modify obstype for amsre
  setuprw.f90              - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps
  setupspd.f90             - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps
  setupsrw.f90             - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps
  setupsst.f90             - bug fix: lat/lon arrays were inverted to diag file
  setupt.f90               - bug fix: lat/lon arrays were inverted to diag 
                             file; add code to include boundary layer model 
                             option; remove psfcg by using ges_lnps; modify 
                             statistics and gross check by variational qc; add
                             ratio(original error/inflated error) to 
                             diagnostic output; modify the weight output in 
                             diagnostic output; add option to perturb 
                             conventional obs
  setupw.f90               - bug fix: lat/lon arrays were inverted to diag 
                             file; remove psfcg by using ges_lnps; modify 
                             statistics and gross check by variational qc; 
                             add ratio(original error/inflated error) to 
                             diagnostic output; modify the weight output in 
                             diagnostic output; add option to perturb 
                             conventional obs
  smoothrf.f90             - set nmix=nr+1+(ny-nlat)/2 to make sure
                             nmix+nrmxb=nr no matter what number nlat is
  sst_retrieval.f90        - modified bufr output of SST retrieval to be 
                             consistent with the format used in the 
                             operational 1/12 RTG daily SST analysis; add 
                             code to handle the case when SST > 31.0C or 
                             SST < -1.0C
  statsconv.f90            - cosmetic changes for gps data
  statsoz.f90              - change location of ozmz to guess_grids from obsmod
  statsrad.f90             - add amsre variants to prinout
  stpcalc.f90              - modify call to stpt for boundary layer model; 
                             separate tendencies from Jc term; add call to 
                             calctends tlm; remove interfaces and clean up 
                             code; make stepsize and penalty calculations 
                             reproducible; add call stpbend for gps bending 
                             angle data; rename tlm routine and variables to 
                             be consistent with gsi coding convention
  stpdw.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpjc.f90                - remove call to calctends_tlm, tendencies passed in
  stplimq.f90              - remove interfaces; return if factqmin=factqmax=0;
                             rename tlm routine and variables to be consistent 
                             with gsi coding convention
  stpoz.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stppcp.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpps.f90                - remove interfaces; modify penalty calculation for
                             variational qc; rename tlm routine and variables
                             to be consistent with gsi coding convention
  stppw.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpq.f90                 - remove interfaces; modify penalty calculation for 
                             variational qc; rename tlm routine and variables
                             to be consistent with gsi coding convention
  stprad.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpref.f90               - remove interfaces; correct bugs, clean up code;
                             rename tlm routine and variables to be consistent 
                             with gsi coding convention
  stprw.f90                - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpspd.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpsrw.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  stpsst.f90               - remove interfaces; rename tlm routine and 
                             variables to be consistent with gsi coding
                             convention
  stpt.f90                 - include boundary layer model option; modify 
                             penalty calculation for variational qc; rename
                             tlm routine and variables to be consistent 
                             with gsi coding convention
  stpw.f90                 - remove interfaces; modify penalty calculation 
                             for variational qc; rename tlm routine and 
                             variables to be consistent with gsi coding 
                             convention
  support_2dvar.f90        - make handling of qoption=1 similar to that 
                             for qoption=2; remove external iteration 
                             dependent calculations
  tpause.f90               - remove psfcg by using ges_lnps
  wrf_binary_interface.F90 - add changes to allow earlier reading of surface 
                             fields needed for intelligent thinning of 
                             satellite data
  wrf_netcdf_interface.F90 - initialize character variable staggering
  wrwrfmassa.F90           - remove qsat_fix array



MAKEFILE CHANGES
----------------
The following changes are made to Makefiles:

 a) Makefile
     - export of gmao_global_convinfo.txt added; merge w/ ncep-gsi-2005_10
     - add, remove, rename files to be consistent with above source code 
       changes

 b) Makefile.conf.Linux.IA64.ifort 
     - add line to compile read_ssmi using FFLAGS_nobig options

 d) Makefile.conf.OSF1              
     - add LIBmpi definition
     - add line to compile read_ssmi using FFLAGS_nobig options

 e) Makefile.dependency            
     - update dependencies to be consistent with above source code changes



SCRIPT CHANGES
--------------
The folowing changes are made to the indicated script files:

 a) analyzer 
     - modified to point to latest version of fixed files;
       also to accommnodate changes due to native grid analysis

 b) rungsi_global.sh
     - update test case to 2005102312 analysis at T382L64 resolution

     - activate variational qc on 60th iteration of first outer loop and
       on all iterations of second outer loop.  This is done by adding
       the "niter_no_qc(1)=60,niter_no_qc(2)=0," to namelist SETUP

       PLEASE NOTE:  Variational QC in the global gsi is still under 
                     development.  Variational QC is turned on in the
                     global gsi script simply to exercise the code.
                     Variational QC in the regional gsi remains to be
                     investigated and, hence, is not turned on in any
                     regional gsi scripts.

     - decrease the scaling factors for the limq moisture constraint 
       from "factqmin=0.8,factqmax=1.2" to "factqmin=0.07,factqmax=0.07"
       This is related to the resolution increase.  With increased resolution
       the potential number of negative and/or supersaturated grid points
       increases.  A decrease in these factors is necessary to maintain
       a relative constant magnitude in the limq penalty through the
       minimization.

     - increase number of process data types from ndat=40 to ndat=44 in 
       namelist SETUP.  In conjunction with this and other changes make
       the following changes/additions to namelist OBS_IMPUT:
   dfile(28)='gps',       dtype(28)='gps_ref',   id(28)=0,  dval(28)=1.0,  dthin(28)=0,
   dfile(30)='amsuabufr', dtype(30)='amsua',     id(30)=18, dval(30)=10.0, dthin(30)=1,
   dfile(31)='mhsbufr',   dtype(31)='mhs',       id(31)=18, dval(31)=3.0,  dthin(31)=2,
   dfile(32)='hirs4bufr', dtype(32)='hirs/3',    id(32)=18, dval(32)=1.0,  dthin(32)=3,
   dfile(36)='amsrebufr', dtype(36)='amsre_low', id(36)=49, dval(36)=1.0,  dthin(36)=4,
   dfile(37)='amsrebufr', dtype(37)='amsre_mid', id(37)=49, dval(37)=1.0,  dthin(37)=4,
   dfile(38)='amsrebufr', dtype(38)='amsre_hig', id(38)=49, dval(38)=1.0,  dthin(38)=4,
   dfile(39)='ssmisbufr', dtype(39)='ssmis_las', id(39)=16, dval(39)=1.0,  dthin(39)=4,
   dfile(40)='ssmisbufr', dtype(40)='ssmis_uas', id(40)=16, dval(40)=1.0,  dthin(40)=4,
   dfile(41)='ssmisbufr', dtype(41)='ssmis_img', id(41)=16, dval(41)=1.0,  dthin(41)=4,
   dfile(42)='ssmisbufr', dtype(42)='ssmis_env', id(42)=16, dval(42)=1.0,  dthin(42)=4,
   dfile(43)='sbuvbufr',  dtype(43)='sbuv2',     id(43)=17, dval(43)=1.0,  dthin(43)=0,
   dfile(44)='omi',       dtype(44)='omi',       id(44)=100,dval(44)=1.0,  dthin(44)=0,

     - to turn on the boundary layer model, set sfcmodel=.true. in namelist 
       SETUP.  The same remark applies to rungsi_regional*sh routines.  
       The boundary layer model has NOT been tested in the 2D-VAR gsi 
       configuration

     - turn on sub-division of uppermost two model layers for radiative
       transfer calculation.  This is done in namelist GRIDOPTS via
       "nlayers(63)=3,nlayers(64)=6".   These settings sub-divide the
       63rd and 64th GFS model layers into 3 and 6 sub-layers, respectively.
       Please see setuprad.f90 for more details.  This treatment was found
       beneficial in damping large Jacobian sensitivities in the uppermost
       model layer.

     - change the following background error parameters in namelist BKGERR
         as=0.45,0.45,0.7,0.8,0.5,0.5,1.0,1.0,
         vs=0.7,
         hzscl=0.6,1.2,2.0,
         hswgt=0.45,0.3,0.25
         norsp=4,
       These values are based on tunning tests running the global GSI at 
       T382L64.  Please see the code for the meaning of the above variables

     - change scaling parameters used in dynamical constraint (namelist 
       JCOPTS) to
         jcterm=.true.,damptend=1.0,bamp_pse=1.0e6,bamp_uve=1.0e6,
         bamp_uvi=1.0e4, bamp_tin=1.0e4

       NOTE that this change turns on the dynamic constraint.  Doing so
       obviously alters analysis results

     - utilize conventional observation error file to replace observation
       errors encoded with data in prepbufr file.  This is achieved by
       toggling logical oberrflg=.true. in namelist OBSQC.  The observation
       error table used by the code is that associated with script variable 
       $errtable
     
     - point to the operational bufr table (/nwprod/fix/bufrtab.012) when 
       using the gsi in sst retrieval mode

     - add NOAA-18 HIRS/4, NOAA-18 MHS, OMI total ozone data to the 
       T382L64 test case.

     - automatically execute utilities which convert guess and analysis
       files to formats which may be easily viewed using local graphical
       tools.  This is done only for the purpose of regression testing.

     - increase the diagnostic file list to include new data types
       processed by GSI

 c) rungsi_regional_mass_binary.sh
     - change test case to more recent case (2005102312)

     - use qoption=2 instead of qoption=1 (namelist SETUP)

     - increase ndat from 40 to 44 (see rungsi_global.sh comments above).
       Make corresponding changes in namelist OBS_INPUT

     - alter scaling factors (namelist JCOPTS) used in dynamical constraint to
       bamp_pse=3.0e5,bamp_uve=3.0e5, bamp_uvi=3.0e4,bamp_tin=3.0e4,

     - toggle conventional observation error table flag oberrflg to .true.
       (namelist OBSQC) 

     - utilize nmm drived background error

     - point to the operational bufr table (/nwprod/fix/bufrtab.012) when
       using the gsi in sst retrieval mode

     - automatically execute utilities which convert guess and analysis
       files to formats which may be easily viewed using local graphical
       tools.  This is done only for the purpose of regression testing.

     - increase the diagnostic file list to include new data types
       processed by GSI

 d) rungsi_regional_nmm_netcdf.sh, rungsi_regional_mass_binary.sh, 
    rungsi_regional_mass_netcdf.sh
     - use qoption=2 instead of qoption=1 (namelist SETUP)

     - increase ndat from 40 to 44 (see rungsi_global.sh comments above).
       Make corresponding changes in namelist OBS_INPUT

     - toggle conventional observation error table flag oberrflg to .true.
       (namelist OBSQC)

     - point to the operational bufr table (/nwprod/fix/bufrtab.012) when
       using the gsi in sst retrieval mode

     - increase the diagnostic file list to include new data types
       processed by GSI

 e) rungsi_regional_twodvar_binary.sh
     - new script to exercise gsi 2d variational analysis option



FIX FILE CHANGES
----------------
The following changes are made to fix files:

 a) gmao_global_convinfo.txt
     - merged w/ ncep-gsi_2005_10

 b) global_convinfo.txt
     - modify variational qc parameters var_b and var_pg for some conventional
       data types
     - add observation type "gps_bnd", gps bending angle to table
 
 c) global_ozinfo.txt
     - toggle usage flag for OMI total ozone to monitor only
 
 d) global_satinfo.txt
     - correct polarization of MHS channels 3 and 4.

 e) regional_convinfo.txt
     - add observation type "gps_bnd", gps bending angle to table

 f) regional_satinfo.txt 
     - turn off assimilation of AMSU-A channels 1-5, 15 on NOAA 15, 16, 18, 
       and AQUA 

 g) remove sst_bufrtab.012 from fix directory since code now uses 
    /nwprod/fix/bufrtab.012





GLOBAL NCEP T382L64 TEST
------------------------
Script  :  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512/rungsi_global.sh
Old code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200510
New code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512

Maximum resident set size
old*:   661740 Kbytes
new*:   663928 Kbytes
old :  1232672 Kbytes
new :  1357688 Kbytes
newv:  1357492 Kbytes

Wall clock (48 tasks, nodes=24)
old*: 1298.611480 seconds (48 tasks, nodes=12)
new*: 1304.084116 seconds (48 tasks, nodes=12)
old : 3082.098509 seconds (48 tasks, nodes=24)
new : 3125.783230 seconds (48 tasks, nodes=24)
newv: 2998.165718 seconds (48 tasks, nodes=24)

Output from the first iteration of the minimization
old*: penalty,grad ,a,b= 1 0 0.808209150336013874E+06 0.493672453465748355E+08 0.852002768862967792E-03 0.000000000000000000E+00
new*: penalty,grad ,a,b= 1 0 0.808423770496243611E+06 0.501632165870373175E+08 0.807331853034037503E-03 0.000000000000000000E+00
old : penalty,grad ,a,b= 1 0 0.692712923654246144E+06 0.975746807379674725E+07 0.442374760840953934E-02 0.000000000000000000E+00
new : penalty,grad ,a,b= 1 0 0.695319310181544162E+06 0.970529767896815017E+07 0.434391804723576087E-02 0.000000000000000000E+00
newv: penalty,grad ,a,b= 1 0 0.695319310181544162E+06 0.970529767896815017E+07 0.434391804723576087E-02 0.000000000000000000E+00

Output from the final iteration of the minimization
old*: penalty,grad ,a,b= 2 100 0.366370154300883762E+06 0.294310531780590303E+06 0.839966055772694556E-04 0.128480915244266858E+01
new*: penalty,grad ,a,b= 2 100 0.372649404656638624E+06 0.424616276498700026E+06 0.168774022983477515E-03 0.118649336226997471E+01
old : penalty,grad ,a,b= 2 100 0.431717429573358560E+06 0.864337156973956212E+03 0.425545213009546517E-03 0.139840772644653777E+01
new : penalty,grad ,a,b= 2 100 0.437082446187673137E+06 0.330252595927716300E+03 0.149145357535186143E-02 0.488172764837552786E+00
newv: penalty,grad ,a,b= 2 100 0.420497605588523438E+06 0.175147305076344423E+04 0.996053243003757523E-03 0.110085975574692396E+01

NOTES:
   a) Increase in memory and wall clock time due to increase in resolution of
      test case from T254L64 to T382L64.  NCEP operations runs at T382L64.  
      The old* and new* numbers are with respect to the previous T254L64 test
      case.
   b) Changes in initial penalty are due to changes in the test case.  The 
      T254L64 test case was for a 2004092100 analysis.  The current T382L64 
      test case is for a 2005102312 analysis.  Running the new code for the 
      2004092100 case yields virtually the same initial penalty, as shown 
      above.  The slight difference in initial penalties for the old case is 
      due to changes in the random number generator used in the new code.  
      See comments for pcpinfo.f90 above for further details.
   c) "newv" refers to running the global gsi case with varitional qc turned
      on as it is in rungsi_global.sh.  The variational qc is turned on 
      at the 60th iteration of the first outer loop and is on for all 
      iterations of the second outer loop.  Users may decide to run 
      with the variational qc off.  It is on only for test purposes.


REGIONAL NCEP NMM BINARY TEST
-----------------------------
Script  :  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512/rungsi_regional_nmm_binary.sh
Old code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200510
New code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512

Maximum resident set size
old :  475228 Kbytes
new :  519632 Kbytes

Wall clock (48 tasks, nodes=12)
old :  929.687022 seconds
new :  926.71751 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b= 1 0 0.187333598615080147E+06 0.324350713993276879E+08 0.161108969942542926E-03 0.000000000000000000E+00
new : penalty,grad ,a,b= 1 0 0.150476659809649049E+06 0.295208206294617578E+08 0.148966380658503250E-03 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b= 2 100 0.145831913794834370E+06 0.162628097725398902E+04 0.477850494893617881E-03 0.665294714807673881E+00
new : penalty,grad ,a,b= 2 100 0.117465814207114367E+06 0.178814369340881179E+02 0.164876997752569344E-02 0.405641696585215927E+00

NOTES:
   a) The increase in memory usage and wall clock time reflects changes in 
      the test case.  The current NMM BINARY test case is for 2005102312 
      from an EMC MMB parallel using the GSI.  This test case uses more 
      data and covers a large geographic domain than the previous NMM BINARY 
      test case covered.  The old* and new* numbers are for the previous case
      using the 200510 and 200512 gsi codes.



REGIONAL NCEP NMM NETCDF TEST
-----------------------------
Script  :  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512/rungsi_regional_nmm_netcdf.sh
Old code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200510
New code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512

Maximum resident set size
old :  216648 Kbytes
new :  219384 Kbytes

Wall clock (24 tasks, nodes=6)
old :  369.309827 seconds
new :  305.807649 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b= 1 0 0.312530062813417899E+05 0.794440541773478268E+06 0.258169281554221103E-02 0.000000000000000000E+00
new : penalty,grad ,a,b= 1 0 0.273088264806887237E+05 0.636432089328166447E+06 0.239407582087830181E-02 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b= 2 88 0.225789296716292447E+05 0.762019065860231287E-04 0.895451588091302798E-02 0.927097314419190743E+00
new : penalty,grad ,a,b= 2 70 0.201910813909321296E+05 0.578156569433122100E-04 0.425290758934856530E-01 0.685846257726994812E+00

NOTES:
   a) The reduction in the initial penalty in the new code is due to the 
      turning off of assimilation of AMSU-A channels 1-5 and 15 for regional 
      GSI runs.  Recent regional gsi parallel experiments revealed an 
      inconsistency in temperature increments forced by satellite data and 
      those forced by in-situ rawinsonde data over northern Canada.  While 
      the cause for this discrepancy remains under investigation, AMSU-A 
      channels 1-5 and 15 are turned off (iuse=-1).  Doing so was found to 
      minimize the inconsistency of the analysis temperature increment with 
      respect to the in-situ sonde data.



REGIONAL NCEP MASS BINARY TEST
------------------------------
Script  :  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512/rungsi_regional_mass_binary.sh
Old code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200510
New code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512

Maximum resident set size
old :  237156 Kbytes
new :  237508 Kbytes

Wall clock (24 tasks, nodes=6)
old :  406.245391 seconds
new :  393.300672 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b= 1 0 0.297895327611723551E+05 0.159979741571810208E+08 0.270361508771306005E-03 0.000000000000000000E+00
new : penalty,grad ,a,b= 1 0 0.298488521499862218E+05 0.157244719872385580E+08 0.275442841541106043E-03 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b= 2 100 0.153430266860274005E+05 0.354079743409249204E+03 0.895934332749832819E-03 0.402068176210905959E+00
new : penalty,grad ,a,b= 2 100 0.151835162191882209E+05 0.302897110329113104E+03 0.600128980922145388E-03 0.961543264141132115E+00



REGIONAL NCEP MASS NETCDF TEST
------------------------------
Script  :  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512/rungsi_regional_mass_netcdf.sh
Old code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200510
New code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512

Maximum resident set size
old :  241368 Kbytes
new :  240668 Kbytes

Wall clock (24 tasks, nodes=6)
old :  345.474905 seconds
new :  298.779901 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b= 1 0 0.403134184768802952E+05 0.369794515315015451E+06 0.101632854821499270E-01 0.000000000000000000E+00
new : penalty,grad ,a,b= 1 0 0.362935273818532587E+05 0.241405577564830630E+06 0.116240538018160550E-01 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b= 2 73 0.286133032737688627E+05 0.270650583231057605E-04 0.212016924799458169E-01 0.492630702418475119E+00
new : penalty,grad ,a,b= 2 70 0.262668035235406533E+05 0.202326406733268451E-04 0.336996756777608389E-01 0.414362786497749769E+00

NOTES:
   a) The reduction in the initial penalty in the new code is due to 
      corrections in the specification of mass core netcdf surface 
      conditions.  With the previous version the surface characteristics 
      were not correctly extracted from the guess file.  The resulting 
      simulated brightness temperatures were biased, thereby leading to 
      a larger initial penalty.  This update corrects this part of the 
      code with a corresponding decrease in the penalty (even though the 
      number of AMSU-A observations passing QC increases).



REGIONAL NCEP TWODVAR BINARY TEST
---------------------------------
Script  :  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512/rungsi_regional_twodvar_binary.sh
Old code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200510
New code:  /nfsuser/g01.1/weather/wx20rt/gsi_anl/sorc/gsi_cvs.200512

Maximum resident set size
old :  264472 Kbytes
new :  264196 Kbytes

Wall clock (24 tasks, nodes=6)
old :  291.626248 seconds
new :  325.040477 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b= 1 0 0.567637776617817435E+05 0.328570592361388728E+06 0.198311611969013146E-01 0.000000000000000000E+00
new : penalty,grad ,a,b= 1 0 0.567637776617817435E+05 0.328538326412036840E+06 0.198365850765129248E-01 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b= 2 80 0.443177927706723640E+05 0.325675426458813021E-03 0.121109518905790671E-01 0.836755642079325512E+00
new : penalty,grad ,a,b= 2 80 0.444910158648351862E+05 0.312040793961442789E-03 0.127586661643548423E-01 0.765838716234202854E+00
